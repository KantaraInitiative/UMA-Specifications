<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc PUBLIC "-//IETF//DTD RFC 2629//EN"
"http://xml.resource.org/authoring/rfc2629.dtd" [
<!ENTITY RFC2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC6749 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6749.xml">
<!ENTITY RFC6750 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6750.xml">
<!ENTITY RFC6415 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6415.xml">
<!ENTITY RFC7159 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7159.xml">
<!ENTITY RFC7519 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7519.xml">
<!ENTITY RFC7591 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7591.xml">
<!ENTITY RFC3986 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3986.xml">
<!ENTITY RFC6819 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6819.xml">
<!ENTITY RFC6711 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6711.xml">
<!ENTITY RFC7662 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7662.xml">
]>
<rfc category="std" docName="draft-uma-claims-ext" id="kantara" ipr="kantara"
  target="publicReview" version="1.0">
  <?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

  <?rfc toc='yes' ?>

  <?rfc tocdepth='4' ?>

  <?rfc symrefs='yes' ?>

  <?rfc sortrefs='yes' ?>

  <?rfc compact='yes' ?>

  <?rfc subcompact='no' ?>

  <front>
    <title abbrev="UMA Core">UMA Enhanced Claims-Gathering Security
    Extension</title>

    <author fullname="Maciej Machulak" initials="M." role="editor"
            surname="Machulak">
      <organization>Synergetics</organization>

      <address>
        <email>maciej@synergetics.be</email>
      </address>
    </author>

    <author fullname="Eve Maler" initials="E." surname="Maler">
      <organization>ForgeRock</organization>

      <address>
        <email>eve.maler@forgerock.com</email>
      </address>
    </author>

    <author fullname="Domenico Catalano" initials="D." surname="Catalano">
      <organization>Oracle</organization>

      <address>
        <email>domenico.catalano@oracle.com</email>
      </address>
    </author>

    <date day="21" month="February" year="2016" />

    <abstract>
      <t>User-Managed Access (UMA) is a profile of OAuth 2.0. UMA defines how
      resource owners can control protected-resource access by clients
      operated by arbitrary requesting parties, where the resources reside on
      any number of resource servers, and where a centralized authorization
      server governs access based on resource owner policies. This extension
      to UMA V1.0 and V1.0.1 enhances security by adding entropy to the UMA
      permission ticket to avoid a session fixation attack through the use of
      the requesting party claims endpoint.</t>
    </abstract>
  </front>

  <middle>
    <section anchor="introduction" title="Introduction">
      <t>User-Managed Access <xref target="UMA" /> is a profile of OAuth 2.0
      <xref target="RFC6749" />. UMA defines how resource owners can control
      protected-resource access by clients operated by arbitrary requesting
      parties, where the resources reside on any number of resource servers,
      and where a centralized authorization server governs access based on
      resource owner policies. This extension to UMA V1.0 and V1.0.1 enhances
      security by adding entropy to the UMA permission ticket to avoid a
      session fixation attack through the use of the requesting party claims
      endpoint.</t>
      
      <t>It is RECOMMENDED for UMA authorization servers and clients
      that intend to use trust elevation methods involving the requesting
      party claims endpoint, versus any other methods, to use this extension.
      [ISSUE: Does this RECOMMENDATION make sense to appear in this doc? Should
      such RECOMMENDATION eventually appear in the core spec instead?]</t>

      <section title="Notational Conventions">
        <t>The key words 'MUST', 'MUST NOT', 'REQUIRED', 'SHALL', 'SHALL NOT',
        'SHOULD', 'SHOULD NOT', 'RECOMMENDED', 'MAY', and 'OPTIONAL' in this
        document are to be interpreted as described in <xref
        target="RFC2119" />.</t>

        <t>Unless otherwise noted, all protocol properties and values are case
        sensitive. JSON <xref target="RFC7159" /> data structures defined by
        this specification MAY contain extension properties that are not
        defined in this specification. Any entity receiving or retrieving a
        JSON data structure SHOULD ignore extension properties it is unable to
        understand. Extension names that are unprotected from collisions are
        outside the scope of this specification.</t>
      </section>

      <section anchor="summary"
               title="Extension Summary and Configuration Data">
        <t>Following is a summary of this extension and how its identifying
        URI is used.<list style="symbols">
            <t>Identifying URI: <spanx
            style="verb">https://docs.kantarainitiative.org/uma/extensions/claims-sec-1.0</spanx><list
                style="symbols">
                <t>An UMA V1.0 or V1.0.1 authorization server that supports
                this extension MUST provide this identifying URI in the <spanx
                style="verb">uma_profiles_supported</spanx> property in its
                configuration data.</t>
              </list></t>

            <t>Extension author and contact information: Maciej Machulak
            (maciej@synergetics.be).</t>

            <t>Updates or obsoletes: None; this extension is new.</t>

            <t>Security considerations: None additional. The topic of the
            extension is security.</t>

            <t>Privacy considerations: None additional.</t>

            <t>Error states: None additional.</t>
          </list></t>
      </section>
    </section>

    <section anchor="getting-authz-accessing-resource"
             title="Security Extension">
      <t>If the client redirects the requesting party end user to the requesting party
      claims endpoint at the authorisation server, the UMA V1.0 and V1.0.1 specifications define that the
      authorization server must return the user agent to the client with, among
      other parameters, a <spanx style="verb">ticket</spanx> parameter whose
      value is the same as the permission ticket value the client sent to this authorisation server
      previously. The <spanx style="verb">ticket</spanx> parameter in the response from the
        authorization server is required only when the authorization
      server previously sent the client a <spanx
      style="verb">need_info</spanx> response. It is possible for the <spanx
      style="verb">need_info</spanx>/<spanx style="verb">ticket</spanx> cycle
      to repeat.</t>

      <t>A session fixation attack is possible when an attacker 
      An attacker uses a client with the same client identifier as the legitimate one
      and phishes a legitimate requesting party into completing a claims-gathering flow at the requesting
      party claims endpoint of the authorization server. 
      Despite completing a claims-gathering flow, a legitimate user 
      Instead, the attacker takes over and completes the original session with the
      permission ticket that remains static throughout the transaction.</t>
      
      <t>The attack is possible because of a constant permission ticket pointing
      to an authorisation state at the authorisation server when such authorisation
      state can change (i.e. initially the authorisation state refers to the permissions
      as registered by the resource server while after successful completion
      of the claims-gathering flow such state can refer to an authorised set ot permissions).</t>

      <t>To mitigate this attack, the authorization server MUST select a new
      securely random value for the permission ticket every time it adds a
      <spanx style="verb">ticket</spanx> query parameter to the
        <spanx style="verb">claims_redirect_uri</spanx> after a claims-gathering workflow.
        (see Section 3.6.3 in <xref target="UMA" />)</t>
      
      <t>
        UMA deployments that implement this specification have to make the permission
        ticket securely random and different at each step of the UMA protocol. The <spanx style="verb">ticket</spanx>
        parameter value that points to a particular permission registered by the
        resource server MUST be updated whenever a ticket is submitted by the client
        to the Authorization Server. This makes each permission ticket a nonce that
        is linked with the registered permission. Importantly, once the ticket value
        is changed the old value MUST be invalidated. As such, the permission registered
        by the resource server at the authorization server MUST be linked with a single
        permission ticket only. In this scheme, a client can only present a given ticket
        one time, and receives a new value to replace with it upon presentation. This
        works for the claims gathering workflow as well as the re-authentication workflow
        described in Section 3.6.1 of the UMA specification <xref target="UMA"></xref>.
      </t>

      <t>This specification extension waives the
        requirement that permission tickets must not be single use. Instead, it
        imposes a requirement that permission tickets must be single use and securely random. This
        change affects the following sections of the UMA protocol specification <xref target="UMA"></xref>:<list>
          <t style="symbols">Section 3.2.2</t>
          <t style="symbols">Section 3.6.3</t>
          <t style="symbols">...</t>
        </list>
      </t>

      <t>[ISSUE: Point to a "friendly doc" in the non-normative refs?]</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This document makes no requests of IANA.</t>
    </section>

    <section anchor="Acknowledgments" title="Acknowledgments">
      <t>The following people made significant contributions to the Work
      Group's understanding of the attack (in alphabetical order):<list
          style="symbols">
          <t>Josh Mandel</t>

          <t>Justin Richer</t>

          <t>Sarah Squire</t>
        </list></t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      <reference anchor="UMA"
                 target="https://docs.kantarainitiative.org/uma/rec-uma-core-v1_0_1.html">
        <front>
          <title>User-Managed Access (UMA) Profile of OAuth 2.0</title>

          <author initials="T." surname="Hardjono">
            <organization>MIT</organization>
          </author>

          <date day="28" month="December" year="2015" />
        </front>
      </reference>

      <reference anchor="BCP195" target="https://tools.ietf.org/html/bcp195">
        <front>
          <title>Recommendations for Secure Use of Transport Layer Security
          (TLS) and Datagram Transport Layer Security (DTLS)</title>

          <author initials="Y." surname="Sheffer">
            <organization />
          </author>

          <date day="" month="May" year="2015" />
        </front>
      </reference>

      &RFC2119;

      &RFC3986;

      &RFC6415;

      &RFC6711;

      &RFC6749;

      &RFC6750;

      &RFC6819;

      &RFC7159;

      &RFC7519;

      &RFC7591;

      &RFC7662;
    </references>

    <references title="Informative References">
      <reference anchor="UMAnitarians"
                 target="https://kantarainitiative.org/confluence/display/uma/Participant+Roster">
        <front>
          <title>UMA Participant Roster</title>

          <author initials="E." surname="Maler">
            <organization>Maler</organization>
          </author>

          <date day="" month="" year="2015" />
        </front>
      </reference>
    </references>
  </back>
</rfc>
