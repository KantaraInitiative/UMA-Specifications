<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc PUBLIC "-//IETF//DTD RFC 2629//EN"
"http://xml.resource.org/authoring/rfc2629.dtd" [
<!ENTITY RFC2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC6749 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6749.xml">
<!ENTITY RFC7159 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7159.xml">
]>
<rfc category="std" docName="draft-uma-claims-ext" id="kantara" ipr="kantara"
     target="publicReview" version="1.0">
  <?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

  <?rfc toc='yes' ?>

  <?rfc tocdepth='4' ?>

  <?rfc symrefs='yes' ?>

  <?rfc sortrefs='yes' ?>

  <?rfc compact='yes' ?>

  <?rfc subcompact='no' ?>

  <front>
    <title abbrev="uma-claims-sec-ext">UMA Claims-Gathering Extension for
    Enhanced Security</title>

    <author fullname="Maciej Machulak" initials="M." role="editor"
            surname="Machulak">
      <organization>Synergetics</organization>

      <address>
        <email>maciej@synergetics.be</email>
      </address>
    </author>

    <author fullname="Eve Maler" initials="E." surname="Maler">
      <organization>ForgeRock</organization>

      <address>
        <email>eve.maler@forgerock.com</email>
      </address>
    </author>

    <author fullname="Domenico Catalano" initials="D." surname="Catalano">
      <organization>Oracle</organization>

      <address>
        <email>domenico.catalano@oracle.com</email>
      </address>
    </author>

    <date day="22" month="March" year="2016" />

    <abstract>
      <t>This extension to UMA enhances security by providing an alternate
      requesting party claims endpoint that adds entropy to the UMA permission
      ticket to avoid a session fixation attack.</t>
    </abstract>
  </front>

  <middle>
    <section anchor="introduction" title="Introduction">
      <t>This extension to UMA enhances security by providing an alternate
      requesting party claims endpoint that adds entropy to the UMA permission
      ticket to avoid a session fixation attack. The extension applies to V1.0
      <xref target="UMA10" />, UMA V1.0.1 <xref target="UMA101" />, and any
      version of UMA susceptible to the identical attack. </t>

      <section title="Notational Conventions">
        <t>The key words 'MUST', 'MUST NOT', 'REQUIRED', 'SHALL', 'SHALL NOT',
        'SHOULD', 'SHOULD NOT', 'RECOMMENDED', 'NOT RECOMMENDED', 'MAY', and
        'OPTIONAL' in this document are to be interpreted as described in
        <xref target="RFC2119" />.</t>

        <t>Unless otherwise noted, all protocol properties and values are case
        sensitive. JSON <xref target="RFC7159" /> data structures defined by
        this specification MAY contain extension properties that are not
        defined in this specification. Any entity receiving or retrieving a
        JSON data structure SHOULD ignore extension properties it is unable to
        understand. Names of such extension properties that are unprotected
        from collisions are outside the scope of this specification.</t>
      </section>

      <section anchor="summary"
               title="Extension Summary and Configuration Data">
        <t>Following is a summary of this extension and how its identifying
        URI is used.<list style="symbols">
            <t>Identifying URI: <spanx
            style="verb">https://docs.kantarainitiative.org/uma/extensions/claims-sec-1.0</spanx><list
                style="symbols">
                <t>An UMA authorization server implementing this specification
                MUST provide this identifying URI in the <spanx
                style="verb">uma_profiles_supported</spanx> property in its
                configuration data.</t>
              </list></t>

            <t>Extension author and contact information: Maciej Machulak
            (maciej@synergetics.be).</t>

            <t>Updates or obsoletes: None; this extension is new.</t>

            <t>Security considerations: None additional. The purpose of the
            extension is security.</t>

            <t>Privacy considerations: None additional.</t>

            <t>Error states: None additional.</t>
          </list></t>
      </section>
    </section>

    <section anchor="getting-authz-accessing-resource"
             title="Security Extension">
      <t>See <xref target="UMAsession" /> for background information on this
      attack, the provided mitigation, and further discussion.</t>

      <section title="Purpose and Applicability of the Extension">
        <t>One of the methods of requesting party trust elevation defined by
        UMA is redirecting an end-user requesting party to the authorization
        server for claims-gathering. This method is susceptible to a session 
        fixation attack. The consequence is that a malicious requesting party
        may be able to access a protected resource not intended for access by
        that party.</t>

        <t>This extension mitigates the attack by enhancing the security of
        the claims-gathering mechanism. Any authorization server intending to
        use interactive claims-gathering as the sole means of trust elevation
        SHOULD consider implementing the extension defined in this
        specification.</t>

        <t>Trust elevation through authentication context (requesting party
        authentication at the authorization endpoint) and pushed claims
        (claims provided to the RPT endpoint by the client) are not
        susceptible to this attack.</t>
      </section>

      <section title="Attack Sequence" anchor="attack">
        <t>Preconditions:<list style="symbols">
            <t>The attacker (a malicious requesting party) and the victim (a
            legitimate end-user requesting party) both use a client (same
            instance or different instances) with the same client ID. The
            client(s) are legitimate and uncompromised.</t>

            <t>Both the attacker and the victim already have their respective
              AATs.</t>
          </list></t>

        <t>Sequence:<list style="numbers">
            <t>The attacker attempts access to an UMA-protected resource at a
            resource server that they should not be able to access.</t>

            <t>The resource server registers a requested permission; the
            authorization server returns a permission ticket; and the resource
            server returns a permission ticket (along with other data) to the
            client.</t>

            <t>The client asks for authorization data and RPT at the
            authorization server; the authorization server returns a <spanx
            style="verb">need_info</spanx> response with an <spanx
            style="verb">error_details</spanx> block containing a <spanx
            style="verb">redirect_user</spanx> hint (or the client infers the
            requirement to redirect the victim's browser to the requesting
            party claims endpoint).</t>

            <t>The client attempts to redirect the victim's browser to the
            requesting party claims endpoint, but the attacker prevents this
            redirection and copies the redirect URL (optionally stripping off
            the state parameter), including a permission ticket query
            parameter, and passes it to the victim.</t>

            <t>The victim needs to be tricked to access the URL provided by
            the attacker (e.g. using a phishing technique). After being
            phished with the URL, the victim assists the authorization server
            in completing the claims-gathering process.</t>

            <t>The authorization server redirects the victim back to the
            client. No relevant session is found in the client, so the
            post-redirect request fails. Alternatively, if the attacker
            controls the victim's network access, they prevent communication
            between victim and client.</t>

            <t>After sufficient time has elapsed, the attacker sends a final
            request for an RPT, and receives an RPT with sufficient
            authorization data to access an UMA-protected resource at a resource
            server.</t>

            <t>The attacker gains access to the UMA-protected resource.</t>
          </list></t>
      </section>

      <section title="Mitigation of the Attack">
        <t>To mitigate this attack, an UMA authorization server indicating its
        conformance to this extension through the identifying URI defined in
        <xref target="summary" /> MUST do the following.<list style="symbols">
            <t>The authorization server MUST provide a configuration data
            property for an alternate requesting party claims endpoint in its
            configuration data called <spanx
            style="verb">security_enhanced_claims_endpoint</spanx>, with the
            URI for the endpoint as its value.</t>

            <t>The authorization server MUST replace any use of the originally
            specified requesting party claims endpoint with the
            security-enhanced requesting party claims endpoint for interacting
            with the end-user requesting party to gather claims.
            The authorization server MUST NOT provide a
            configuration data property for the <spanx
            style="verb">requesting_party_claims_endpoint</spanx> configuration
            data. Effectively, this extension supersedes the <xref target="UMA10" />
            and <xref target="UMA101" /> Section 1.4 statement "If this
            property is absent, the authorization server does not interact
            with the end-user requesting party for claims gathering."</t>

            <t>The authorization server MUST, every time it adds a <spanx
            style="verb">ticket</spanx> query parameter to the <spanx
            style="verb">claims_redirect_uri</spanx> after a claims-gathering
            flow at this security-enhanced endpoint, select a new unguessable
            value for the permission ticket and invalidate the
            permission ticket previously received from the client.
            Effectively, this extension supersedes the <xref
            target="UMA101" /> Section 3.2.2 requirement "Permission tickets
            MUST NOT be single-use" and the Section 3.6.3 phrase "The same
            permission ticket value that the client provided in the
            request..."; the ticket, in both its front-channel and
            back-channel correlation roles, becomes a single-use nonce. This
            defeats the attacker's ability to compose a successful RPT request
            in step 7 of the attack described in <xref target="summary" />.</t>
          </list></t>
      </section>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This document makes no requests of IANA.</t>
    </section>

    <section anchor="Acknowledgments" title="Acknowledgments">
      <t>The following people made significant contributions to the Work
      Group's understanding of the attack (in alphabetical order):<list
          style="symbols">
          <t>Josh Mandel</t>

          <t>Justin Richer</t>

          <t>Sarah Squire</t>
        </list></t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      <reference anchor="UMA10"
                 target="https://docs.kantarainitiative.org/uma/rec-uma-core-v1_0.html">
        <front>
          <title>User-Managed Access (UMA) Profile of OAuth 2.0, Version
          1.0</title>

          <author initials="T." surname="Hardjono">
            <organization>MIT</organization>
          </author>

          <date day="04" month="April" year="2015" />
        </front>
      </reference>

      <reference anchor="UMA101"
                 target="https://docs.kantarainitiative.org/uma/rec-uma-core-v1_0_1.html">
        <front>
          <title>User-Managed Access (UMA) Profile of OAuth 2.0, Version
          1.0.1</title>

          <author initials="T." surname="Hardjono">
            <organization>MIT</organization>
          </author>

          <date day="28" month="December" year="2015" />
        </front>
      </reference>

      &RFC2119;

      &RFC7159;
    </references>

    <references title="Informative References">
      <reference anchor="UMAsession"
                 target="http://kantarainitiative.org/confluence/display/uma/Understanding+the+Session+Fixation+Attack+on+UMA+Claims-Gathering+and+the+Provided+Mitigation">
        <front>
          <title>Understanding the Session Fixation Attack on UMA
          Claims-Gathering and the Provided Mitigation</title>

          <author initials="E." surname="Maler">
            <organization>ForgeRock</organization>
          </author>

          <date day="27" month="February" year="2016" />
        </front>
      </reference>
    </references>
  </back>
</rfc>
